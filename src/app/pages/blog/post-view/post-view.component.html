<div class="post-view-page">
  @if (loading()) {
    <div class="loading-container">
      <span class="spinner"></span>
      <span>Cargando publicación...</span>
    </div>
  } @else if (error()) {
    <div class="error-container">
      <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <h2>{{ error() }}</h2>
      <button class="btn-back" (click)="goBack()">Volver al Blog</button>
    </div>
  } @else if (post()) {
    <div class="container">
      <button class="btn-back-top" (click)="goBack()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Volver
      </button>

      <div class="post-view-content">
        <div class="post-view-main" [class.text-only]="(!post()!.images || post()!.images!.length === 0) && !post()!.video">
          @if (post()!.images && post()!.images!.length > 0) {
            <div class="post-image-carousel-view">
              <div class="carousel-container">
                @for (image of post()!.images!; track $index) {
                  <div class="carousel-slide" [class.active]="$index === getCurrentImageIndex()">
                    <img [src]="image" [alt]="post()!.content">
                  </div>
                }
              </div>
              @if (post()!.images!.length > 1) {
                <button class="carousel-btn carousel-btn-prev" (click)="prevImage()" title="Imagen anterior">
                  <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <button class="carousel-btn carousel-btn-next" (click)="nextImage()" title="Siguiente imagen">
                  <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </button>
                <div class="carousel-indicators">
                  @for (image of post()!.images!; track $index) {
                    <button 
                      class="carousel-dot" 
                      [class.active]="$index === getCurrentImageIndex()"
                      (click)="goToImage($index)"
                      [attr.aria-label]="'Ir a imagen ' + ($index + 1)">
                    </button>
                  }
                </div>
                <div class="carousel-counter">
                  {{ getCurrentImageIndex() + 1 }} / {{ post()!.images!.length }}
                </div>
              }
            </div>
          } @else if (post()!.video) {
            <div class="post-video-view">
              <video [src]="post()!.video" controls></video>
            </div>
          } @else {
            <div class="text-post-full">
              <p class="text-content-full" [ngClass]="getTextSizeClass(post()!.content)">{{ post()!.content }}</p>
            </div>
          }
        </div>

        <div class="post-view-sidebar">
          <div class="post-header-section">
            <div class="post-author">
              @if (post()!.authorPhoto) {
                <img 
                  [src]="post()!.authorPhoto" 
                  [alt]="post()!.authorName" 
                  class="author-avatar"
                  (error)="$any($event.target).src='https://ddragon.leagueoflegends.com/cdn/14.24.1/img/profileicon/29.png'"
                  onerror="this.onerror=null; this.src='https://ddragon.leagueoflegends.com/cdn/14.24.1/img/profileicon/29.png';">
              } @else {
                <div class="author-avatar-placeholder">
                  {{ post()!.authorName.charAt(0).toUpperCase() }}
                </div>
              }
              <div class="author-info">
                <a [routerLink]="['/profile', post()!.authorId]" class="author-name-link">
                  {{ post()!.authorName }}
                </a>
                <span class="post-date">{{ formatDate(post()!.createdAt) }}</span>
              </div>
            </div>
          </div>

          @if (post()!.images && post()!.images!.length > 0 || post()!.video) {
            <div class="post-content-section">
              <p class="post-text">{{ post()!.content }}</p>
            </div>
          }

          <div class="post-reactions-section">
            <button class="reaction-btn" (click)="likePost()" [class.liked]="isLiked()">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" [attr.fill]="isLiked() ? 'currentColor' : 'none'">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
              <span>{{ (post()!.likes || []).length }}</span>
            </button>
            <button class="reaction-btn" (click)="dislikePost()" [class.disliked]="isDisliked()">
              <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" [attr.fill]="isDisliked() ? 'currentColor' : 'none'">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
              </svg>
              <span>{{ (post()!.dislikes || []).length }}</span>
            </button>
          </div>

          <div class="comments-section">
            <div class="comments-header">
              <h3>Comentarios</h3>
              <span class="comments-count">{{ (post()!.comments || []).length }}</span>
            </div>
            <div class="comments-list">
              @if ((post()!.comments || []).length === 0) {
                <div class="empty-comments">
                  <p>No hay comentarios aún. ¡Sé el primero en comentar!</p>
                </div>
              } @else {
                @for (comment of post()!.comments || []; track $index; let commentIndex = $index) {
                  <div class="comment-item">
                    <div class="comment-header">
                      @if (comment.authorPhoto) {
                        <img 
                          [src]="comment.authorPhoto" 
                          [alt]="comment.authorName" 
                          class="comment-avatar"
                          (error)="$any($event.target).src='https://ddragon.leagueoflegends.com/cdn/14.24.1/img/profileicon/29.png'"
                          onerror="this.onerror=null; this.src='https://ddragon.leagueoflegends.com/cdn/14.24.1/img/profileicon/29.png';">
                      } @else {
                        <div class="comment-avatar-placeholder">
                          {{ comment.authorName.charAt(0).toUpperCase() }}
                        </div>
                      }
                      <a [routerLink]="['/profile', comment.authorId]" class="comment-author-link">
                        {{ comment.authorName }}
                      </a>
                    </div>
                    <p class="comment-content">{{ comment.content }}</p>
                    <div class="comment-actions">
                      <button class="comment-btn" (click)="likeComment(commentIndex)">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                        </svg>
                        <span>{{ (comment.likes || []).length }}</span>
                      </button>
                      <button class="comment-btn" (click)="dislikeComment(commentIndex)">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
                        </svg>
                        <span>{{ (comment.dislikes || []).length }}</span>
                      </button>
                      <button class="comment-btn reply-btn" (click)="toggleReply(commentIndex)">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                        </svg>
                        <span>Responder</span>
                      </button>
                      @if ((comment.replies || []).length > 0) {
                        <span class="reply-count">{{ (comment.replies || []).length }} {{ (comment.replies || []).length === 1 ? 'respuesta' : 'respuestas' }}</span>
                      }
                    </div>
                    
                    <!-- Respuestas del comentario -->
                    @if ((comment.replies || []).length > 0) {
                      <div class="replies-container">
                        @for (reply of comment.replies || []; track $index; let replyIndex = $index) {
                          <div class="reply-item">
                            <div class="comment-header">
                              @if (reply.authorPhoto) {
                                <img 
                                  [src]="reply.authorPhoto" 
                                  [alt]="reply.authorName" 
                                  class="comment-avatar reply-avatar"
                                  (error)="$any($event.target).src='https://ddragon.leagueoflegends.com/cdn/14.24.1/img/profileicon/29.png'"
                                  onerror="this.onerror=null; this.src='https://ddragon.leagueoflegends.com/cdn/14.24.1/img/profileicon/29.png';">
                              } @else {
                                <div class="comment-avatar-placeholder reply-avatar">
                                  {{ reply.authorName.charAt(0).toUpperCase() }}
                                </div>
                              }
                              <a [routerLink]="['/profile', reply.authorId]" class="comment-author-link">
                                {{ reply.authorName }}
                              </a>
                            </div>
                            <p class="comment-content reply-content">{{ reply.content }}</p>
                            <div class="comment-actions reply-actions">
                              <button class="comment-btn" (click)="likeComment(commentIndex, replyIndex)">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                </svg>
                                <span>{{ (reply.likes || []).length }}</span>
                              </button>
                              <button class="comment-btn" (click)="dislikeComment(commentIndex, replyIndex)">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
                                </svg>
                                <span>{{ (reply.dislikes || []).length }}</span>
                              </button>
                            </div>
                          </div>
                        }
                      </div>
                    }
                    
                    <!-- Input para responder -->
                    @if (replyingToComment() === commentIndex) {
                      <div class="reply-input-container">
                        <input 
                          type="text" 
                          [value]="replyCommentText().get(commentIndex) || ''"
                          (input)="setReplyText(commentIndex, $event.target.value)"
                          placeholder="Escribe una respuesta..."
                          class="comment-input reply-input"
                          (keyup.enter)="addComment(commentIndex)">
                        <button class="send-btn reply-send-btn" (click)="addComment(commentIndex)">
                          <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                          </svg>
                        </button>
                        <button class="cancel-reply-btn" (click)="toggleReply(commentIndex)">Cancelar</button>
                      </div>
                    }
                  </div>
                }
              }
            </div>

            <div class="comment-input-container">
              <input 
                type="text" 
                [(ngModel)]="newComment" 
                placeholder="Añade un comentario..."
                class="comment-input"
                (keyup.enter)="addComment()">
              <button class="send-btn" (click)="addComment()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</div>

