<div class="messages-page">
  <div class="messages-container">
    <!-- Conversations List -->
    <div class="conversations-sidebar">
      <div class="sidebar-header">
        <h2>Mensajes</h2>
      </div>
      <div class="conversations-list">
        @if (conversations().length === 0) {
          <div class="empty-conversations">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <p>No hay conversaciones</p>
          </div>
        } @else {
          @for (conv of conversations(); track conv.userId) {
            <div 
              class="conversation-item" 
              [class.active]="selectedConversation() === conv.userId"
              (click)="selectConversation(conv.userId)">
              <div class="conversation-avatar">
                @if (conv.profile?.photoURL) {
                  <img [src]="conv.profile!.photoURL" [alt]="conv.profile!.displayName">
                } @else {
                  <div class="avatar-placeholder">
                    @if (conv.profile && conv.profile.displayName) {
                      {{ conv.profile.displayName.charAt(0).toUpperCase() }}
                    } @else {
                      ?
                    }
                  </div>
                }
                @if (conv.unread > 0) {
                  <span class="unread-badge">{{ conv.unread }}</span>
                }
              </div>
              <div class="conversation-info" style="flex: 1; min-width: 0;">
                <div class="conversation-header">
                  <span class="conversation-name">{{ conv.profile?.displayName || 'Usuario' }}</span>
                  @if (conv.lastMessage) {
                    <span class="conversation-time">{{ formatTime(conv.lastMessage.timestamp) }}</span>
                  }
                </div>
                <p class="conversation-preview">
                  {{ conv.lastMessage?.content || 'Sin mensajes' }}
                </p>
              </div>
              <div class="conversation-menu">
                <button 
                  class="conversation-menu-btn" 
                  (click)="toggleConversationMenu(conv.userId, $event)"
                  title="M√°s opciones">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                  </svg>
                </button>
                @if (showConversationMenu().get(conv.userId)) {
                  <div class="conversation-menu-dropdown">
                    <button class="menu-item delete" (click)="deleteConversation(conv.userId); closeConversationMenu(conv.userId)">
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      Eliminar conversaci√≥n
                    </button>
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window">
      @if (selectedConversation() && selectedUserProfile()) {
        <div class="chat-header">
          <div class="chat-user-info" (click)="goToUserProfile(selectedConversation()!)" style="cursor: pointer;">
            @if (selectedUserProfile()!.photoURL) {
              <img [src]="selectedUserProfile()!.photoURL" [alt]="selectedUserProfile()!.displayName" class="chat-avatar">
            } @else {
              <div class="chat-avatar-placeholder">
                {{ selectedUserProfile()!.displayName.charAt(0).toUpperCase() }}
              </div>
            }
            <span class="chat-username">{{ selectedUserProfile()!.displayName }}</span>
          </div>
          <button class="minimize-btn" (click)="minimizeChat(selectedConversation()!)">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
            </svg>
          </button>
        </div>
        <div class="chat-messages" #chatContainer>
          @if (messages().length === 0) {
            <div class="empty-messages">
              <p>No hay mensajes a√∫n. ¬°Env√≠a el primero!</p>
            </div>
          } @else {
            @for (message of messages(); track message.id || $index) {
              <div class="message" [class.sent]="message.fromId === currentUser()?.uid" [class.received]="message.fromId !== currentUser()?.uid">
                <div class="message-content">
                  <p>{{ message.content }}</p>
                  <span class="message-time">{{ formatTime(message.timestamp) }}</span>
                </div>
              </div>
            }
          }
        </div>
        <div class="chat-input-container">
          <button class="emoji-button" (click)="toggleEmojiPicker()" type="button">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
          <input 
            type="text" 
            [(ngModel)]="newMessage" 
            placeholder="Escribe un mensaje..."
            class="chat-input"
            (keyup.enter)="sendMessage()">
          <button class="send-button" (click)="sendMessage()" [disabled]="!newMessage().trim()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
          
          <!-- Emoji Picker -->
          @if (showEmojiPicker()) {
            <div class="emoji-picker">
              <div class="emoji-picker-header">
                <button 
                  class="emoji-tab" 
                  [class.active]="emojiTab() === 'normal'"
                  (click)="selectEmojiTab('normal')">
                  üòä Emojis
                </button>
                <button 
                  class="emoji-tab" 
                  [class.active]="emojiTab() === 'riot'"
                  (click)="selectEmojiTab('riot')">
                  ‚öîÔ∏è Riot/LoL
                </button>
              </div>
              <div class="emoji-picker-content">
                @if (emojiTab() === 'normal') {
                  <div class="emoji-grid">
                    @for (emoji of normalEmojis; track $index) {
                      <button 
                        class="emoji-item" 
                        (click)="insertEmoji(emoji)"
                        type="button">
                        {{ emoji }}
                      </button>
                    }
                  </div>
                } @else {
                  <div class="emoji-grid">
                    @for (emoji of riotEmojis; track $index) {
                      <button 
                        class="emoji-item" 
                        (click)="insertEmoji(emoji)"
                        type="button">
                        {{ emoji }}
                      </button>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="no-chat-selected">
          <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p>Selecciona una conversaci√≥n para comenzar</p>
        </div>
      }
    </div>
  </div>

  <!-- Minimized Chats (Stacked Bubbles) -->
  @if (getMinimizedChats().length > 0) {
    <div class="minimized-chats">
      @for (chat of getMinimizedChats(); track chat.userId) {
        <div class="minimized-chat-bubble" (click)="maximizeChat(chat.userId)">
          @if (chat.profile?.photoURL) {
            <img [src]="chat.profile!.photoURL" [alt]="chat.profile!.displayName">
          } @else {
            <div class="bubble-placeholder">
              @if (chat.profile && chat.profile.displayName) {
                {{ chat.profile.displayName.charAt(0).toUpperCase() }}
              } @else {
                ?
              }
            </div>
          }
          <button class="close-bubble" (click)="closeChat(chat.userId); $event.stopPropagation()">
            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      }
    </div>
  }
</div>

