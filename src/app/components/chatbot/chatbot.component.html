<div class="chatbot-container" [attr.data-position]="position" [attr.data-chatbot-id]="chatbotId">
  <!-- BotÃ³n flotante -->
  <button 
    class="chatbot-toggle" 
    [class.open]="isOpen()"
    (click)="toggleChat()"
    [attr.aria-label]="isOpen() ? 'Cerrar chat' : 'Abrir chat'">
    @if (!isOpen()) {
      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
    } @else {
      <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    }
    <span class="chatbot-badge">POTATO @if (modelName !== 'Auto') { ({{ modelName }}) }</span>
  </button>

  <!-- Ventana de chat -->
  @if (isOpen()) {
    <div class="chatbot-window">
      <div class="chatbot-header">
        <div class="chatbot-header-info">
          <div class="chatbot-avatar">
            <span class="potato-emoji">ðŸ¥”</span>
          </div>
          <div class="chatbot-header-text">
            <h3>POTATO @if (modelName !== 'Auto') { <span class="model-badge">{{ modelName }}</span> }</h3>
            <p class="chatbot-status">En lÃ­nea</p>
          </div>
        </div>
        <button class="chatbot-minimize" (click)="toggleChat()" title="Minimizar">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
          </svg>
        </button>
      </div>

      <div class="chatbot-messages" #chatMessages>
        @if (messages().length === 0) {
          <div class="welcome-message">
            <p>Â¡Hola! Soy POTATO, tu asistente virtual. Â¿En quÃ© puedo ayudarte?</p>
          </div>
        } @else {
          @for (message of messages(); track $index) {
            <div class="message" [class.user-message]="message.sender === 'user'" [class.bot-message]="message.sender === 'bot'" [class.expandable]="message.isLong">
              <div class="message-content">
                @if (message.sender === 'bot') {
                  <div class="bot-avatar">
                    <span>ðŸ¥”</span>
                  </div>
                }
                <div class="message-bubble" [class.expanded]="message.expanded">
                  @if (message.isLong && !message.expanded) {
                    <p [innerHTML]="formatMessageText(getMessagePreview(message.text))"></p>
                    <button class="expand-btn" (click)="toggleMessageExpansion($index)">
                      Ver mÃ¡s
                      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                  } @else {
                    <p [innerHTML]="formatMessageText(message.text)"></p>
                    @if (message.isLong && message.expanded) {
                      <button class="collapse-btn" (click)="toggleMessageExpansion($index)">
                        Ver menos
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                        </svg>
                      </button>
                    }
                  }
                  <span class="message-time">{{ formatTime(message.timestamp) }}</span>
                </div>
              </div>
              
            </div>
          }
        }

        @if (isTyping()) {
          <div class="message bot-message">
            <div class="message-content">
              <div class="bot-avatar">
                <span>ðŸ¥”</span>
              </div>
              <div class="message-bubble typing-indicator">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      <div class="chatbot-input-container">
        <input 
          type="text" 
          #chatInput
          [(ngModel)]="userInput"
          (keyup.enter)="sendMessage()"
          placeholder="Escribe tu mensaje..."
          class="chatbot-input"
          maxlength="500">
        <button class="chatbot-send" (click)="sendMessage()" [disabled]="!userInput().trim() || isTyping()">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
    </div>
  }
</div>

